name: release

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  windows-portable:
    name: windows-portable
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pyinstaller

      - name: Build
        run: |
          pyinstaller --noconfirm --clean ^
            --windowed ^
            --name "DSSbrowser" ^
            --add-data "frontend;frontend" ^
            --collect-submodules "PyQt6" ^
            --collect-submodules "PyQt6.QtWebEngineWidgets" ^
            --collect-submodules "PyQt6.QtWebEngineCore" ^
            launch.py
        shell: cmd

      - name: Package (Windows)
        run: |
          powershell -NoProfile -Command "Compress-Archive -Path dist\\DSSbrowser\\* -DestinationPath DSSbrowser-windows-portable.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DSSbrowser-windows-portable
          path: |
            DSSbrowser-windows-portable.zip

  linux-tarball:
    name: linux-tarball
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pyinstaller

      - name: Build
        run: |
          pyinstaller --noconfirm --clean \
            --name "DSSbrowser" \
            --add-data "frontend:frontend" \
            --collect-submodules "PyQt6" \
            --collect-submodules "PyQt6.QtWebEngineWidgets" \
            --collect-submodules "PyQt6.QtWebEngineCore" \
            launch.py
        shell: bash

      - name: Package (Linux)
        run: |
          cp scripts/linux-launch.sh dist/DSSbrowser/DSSbrowser.sh
          chmod +x dist/DSSbrowser/DSSbrowser.sh
          tar -czf DSSbrowser-linux.tar.gz -C dist DSSbrowser

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DSSbrowser-linux-tarball
          path: |
            DSSbrowser-linux.tar.gz

  linux-appimage:
    name: linux-appimage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pyinstaller

      - name: Build
        run: |
          pyinstaller --noconfirm --clean \
            --name "DSSbrowser" \
            --add-data "frontend:frontend" \
            --collect-submodules "PyQt6" \
            --collect-submodules "PyQt6.QtWebEngineWidgets" \
            --collect-submodules "PyQt6.QtWebEngineCore" \
            launch.py
        shell: bash

      - name: Install AppImage deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2

      - name: Package (Linux AppImage)
        run: |
          set -euo pipefail
          export APPIMAGE_EXTRACT_AND_RUN=1
          APPDIR="DSSbrowser.AppDir"
          rm -rf "$APPDIR"
          mkdir -p "$APPDIR/usr/bin" "$APPDIR/usr/share/applications" "$APPDIR/usr/share/icons/hicolor/256x256/apps"
          cp -r "dist/DSSbrowser/." "$APPDIR/usr/bin/"
          cp "frontend/assets/images/icon.png" "$APPDIR/usr/share/icons/hicolor/256x256/apps/dssb-server-browser.png"
          cat > "$APPDIR/usr/share/applications/dssb-server-browser.desktop" <<'EOF'
          [Desktop Entry]
          Type=Application
          Name=DSS Browser
          Exec=DSSbrowser
          Icon=dssb-server-browser
          Categories=Game;
          EOF
          cat > "$APPDIR/AppRun" <<'EOF'
          #!/bin/sh
          # Workarounds for Steam Deck / various distros
          if [ "${DSSB_USE_GPU:-0}" != "1" ]; then
            export QT_OPENGL="${QT_OPENGL:-software}"
            export QTWEBENGINE_DISABLE_SANDBOX="${QTWEBENGINE_DISABLE_SANDBOX:-1}"
            export QTWEBENGINE_CHROMIUM_FLAGS="${QTWEBENGINE_CHROMIUM_FLAGS:---disable-gpu --disable-gpu-compositing --disable-features=UseSkiaRenderer}"
          fi
          exec "$APPDIR/usr/bin/DSSbrowser" "$@"
          EOF
          chmod +x "$APPDIR/AppRun"
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage appimagetool-x86_64.AppImage
          ./linuxdeploy-x86_64.AppImage --appdir "$APPDIR" --output appimage
          ./appimagetool-x86_64.AppImage "$APPDIR" DSSbrowser-x86_64.AppImage

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DSSbrowser-linux-appimage
          path: |
            DSSbrowser-x86_64.AppImage

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs:
      - windows-portable
      - linux-tarball
      - linux-appimage
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/DSSbrowser-windows-portable.zip
            artifacts/**/DSSbrowser-linux.tar.gz
            artifacts/**/DSSbrowser-x86_64.AppImage
        env:
          # If RELEASE_TOKEN is set, it will be used; otherwise default GITHUB_TOKEN is used.
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || github.token }}
